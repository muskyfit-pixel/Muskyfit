
import { GoogleGenAI, Type } from "@google/genai";
import { IntakeData, Meal, WorkoutDay, MacroSplit, FoodItem, DailyLog, WeeklyCheckIn } from "../types";

const getAI = () => new GoogleGenAI({ apiKey: process.env.API_KEY });

export async function generatePerformanceReport(clientName: string, logs: DailyLog[], checkIn: WeeklyCheckIn): Promise<string> {
  const prompt = `Analyze fitness data for client "${clientName}". Recent Logs: ${JSON.stringify(logs.slice(0, 7))}. Check-in: ${JSON.stringify(checkIn)}. TASK: Write an elite coaching report for MuskyFit. Focus on compliance and V-Taper progress for Asian males.`;
  try {
    const ai = getAI();
    const response = await ai.models.generateContent({
      model: "gemini-3-flash-preview",
      contents: prompt,
    });
    return response.text || "Analysis pending.";
  } catch (e) {
    return "Intelligence report error.";
  }
}

export async function generatePersonalizedPlan(data: IntakeData): Promise<any> {
  const ai = getAI();
  const response = await ai.models.generateContent({
    model: "gemini-3-pro-preview", 
    contents: `Build protocol for ${data.name}. Goal: ${data.goal}. Style: ${data.culturalPreference}. Focus on South Asian male professional health.`,
    config: { 
      responseMimeType: "application/json",
      responseSchema: {
        type: Type.OBJECT,
        properties: {
          trainingDayMacros: { type: Type.OBJECT, properties: { calories: { type: Type.NUMBER }, p: { type: Type.NUMBER }, c: { type: Type.NUMBER }, f: { type: Type.NUMBER } } },
          restDayMacros: { type: Type.OBJECT, properties: { calories: { type: Type.NUMBER }, p: { type: Type.NUMBER }, c: { type: Type.NUMBER }, f: { type: Type.NUMBER } } },
          mealPlan: { type: Type.ARRAY, items: { type: Type.OBJECT, properties: { mealType: { type: Type.STRING }, name: { type: Type.STRING }, ingredients: { type: Type.ARRAY, items: { type: Type.STRING } }, instructions: { type: Type.STRING }, macros: { type: Type.OBJECT }, substitutes: { type: Type.ARRAY, items: { type: Type.STRING } } } } },
          workoutSplit: { type: Type.ARRAY, items: { type: Type.OBJECT, properties: { id: { type: Type.STRING }, title: { type: Type.STRING }, day: { type: Type.STRING }, exercises: { type: Type.ARRAY, items: { type: Type.OBJECT } } } } },
          coachAdvice: { type: Type.STRING }
        }
      }
    }
  });
  return JSON.parse(response.text || '{}');
}

export async function searchUniversalFood(query: string): Promise<FoodItem | null> {
  const ai = getAI();
  const response = await ai.models.generateContent({
    model: "gemini-3-flash-preview",
    contents: `Identify nutritional values for 100g of ${query}.`,
    config: { 
      responseMimeType: "application/json",
      responseSchema: {
        type: Type.OBJECT,
        properties: {
          name: { type: Type.STRING },
          calories: { type: Type.NUMBER },
          protein: { type: Type.NUMBER },
          carbs: { type: Type.NUMBER },
          fats: { type: Type.NUMBER },
          servingSize: { type: Type.STRING }
        }
      }
    }
  });
  try {
    const res = JSON.parse(response.text || '{}');
    return { ...res, id: 'ai_' + Date.now(), type: 'INDIAN' };
  } catch (e) {
    return null;
  }
}

export async function getMealAlternatives(meal: Meal): Promise<string[]> {
  const ai = getAI();
  const response = await ai.models.generateContent({
    model: "gemini-3-flash-preview",
    contents: `Suggest 3 healthy Asian alternatives for "${meal.name}" (${meal.macros.calories}kcal).`,
    config: { responseMimeType: "application/json", responseSchema: { type: Type.ARRAY, items: { type: Type.STRING } } }
  });
  try { return JSON.parse(response.text || '[]'); } catch (e) { return []; }
}
