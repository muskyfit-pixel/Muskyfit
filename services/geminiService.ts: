
import { GoogleGenAI, Type, Modality } from "@google/genai";
import { IntakeData, Meal, DailyLog, WeeklyCheckIn, FoodItem, WeeklyReview, LoggedFood } from "../types";

const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

const calculateAge = (dob: string): number => {
  const birthday = new Date(dob);
  const ageDifMs = Date.now() - birthday.getTime();
  const ageDate = new Date(ageDifMs);
  return Math.abs(ageDate.getUTCFullYear() - 1970);
};

export async function generatePersonalizedPlan(data: IntakeData): Promise<any> {
  const age = calculateAge(data.dob);
  const isLifestyleNiche = age >= 30;

  const response = await ai.models.generateContent({
    model: "gemini-3-pro-preview",
    contents: `Build a highly elite 12-week bespoke fitness protocol for ${data.name}. 
    Biometrics: ${age} years old, ${data.gender}, ${data.weight}kg, ${data.height}cm. 
    Profile: ${isLifestyleNiche ? '30+ Lifestyle Professional Focus' : 'High Performance Focus'}.
    Goal: ${data.goal}. 
    Cultural Nutrition Context: ${data.culturalPreference} (${data.dietPreference}).
    
    Specific coaching directives:
    - If Female, optimize for metabolic health and muscle toning.
    - If Male, focus on the V-Taper aesthetic.
    - Include culturally relevant high-protein food options.`,
    config: {
      responseMimeType: "application/json",
      responseSchema: {
        type: Type.OBJECT,
        properties: {
          trainingDayMacros: { 
            type: Type.OBJECT, 
            properties: { calories: { type: Type.NUMBER }, p: { type: Type.NUMBER }, c: { type: Type.NUMBER }, f: { type: Type.NUMBER } },
            required: ["calories", "p", "c", "f"]
          },
          restDayMacros: { 
            type: Type.OBJECT, 
            properties: { calories: { type: Type.NUMBER }, p: { type: Type.NUMBER }, c: { type: Type.NUMBER }, f: { type: Type.NUMBER } },
            required: ["calories", "p", "c", "f"]
          },
          mealPlan: { 
            type: Type.ARRAY, 
            items: { 
              type: Type.OBJECT, 
              properties: { 
                mealType: { type: Type.STRING }, 
                name: { type: Type.STRING }, 
                ingredients: { type: Type.ARRAY, items: { type: Type.STRING } }, 
                instructions: { type: Type.STRING }, 
                macros: { type: Type.OBJECT, properties: { calories: { type: Type.NUMBER }, p: { type: Type.NUMBER }, c: { type: Type.NUMBER }, f: { type: Type.NUMBER } }, required: ["calories", "p", "c", "f"] },
                substitutes: { type: Type.ARRAY, items: { type: Type.STRING } }
              },
              required: ["mealType", "name", "ingredients", "instructions", "macros"]
            } 
          },
          workoutSplit: { 
            type: Type.ARRAY, 
            items: { 
              type: Type.OBJECT, 
              properties: { 
                id: { type: Type.STRING }, title: { type: Type.STRING }, day: { type: Type.STRING },
                exercises: { type: Type.ARRAY, items: { type: Type.OBJECT, properties: { id: { type: Type.STRING }, name: { type: Type.STRING }, sets: { type: Type.NUMBER }, reps: { type: Type.STRING }, targetRpe: { type: Type.NUMBER }, tempo: { type: Type.STRING }, notes: { type: Type.STRING } }, required: ["id", "name", "sets", "reps"] } }
              },
              required: ["id", "title", "day", "exercises"]
            } 
          },
          coachAdvice: { type: Type.STRING }
        },
        required: ["trainingDayMacros", "restDayMacros", "mealPlan", "workoutSplit", "coachAdvice"]
      }
    }
  });
  
  return JSON.parse(response.text);
}

export async function analyzeMealPhoto(base64Image: string): Promise<Partial<LoggedFood> | null> {
  const response = await ai.models.generateContent({
    model: 'gemini-3-flash-preview',
    contents: {
      parts: [
        { inlineData: { mimeType: 'image/jpeg', data: base64Image } },
        { text: "Analyze this meal photo. Identify the food name and estimate Calories, Protein, Carbs, and Fats for the visible portion. Focus on accuracy for South Asian and Global cuisines." }
      ]
    },
    config: {
      responseMimeType: "application/json",
      responseSchema: {
        type: Type.OBJECT,
        properties: {
          name: { type: Type.STRING },
          calories: { type: Type.NUMBER },
          protein: { type: Type.NUMBER },
          carbs: { type: Type.NUMBER },
          fats: { type: Type.NUMBER },
          servingSize: { type: Type.STRING }
        },
        required: ["name", "calories", "protein", "carbs", "fats"]
      }
    }
  });

  try {
    return JSON.parse(response.text);
  } catch { return null; }
}

export async function generateWeeklyAudioBriefing(text: string): Promise<string | null> {
  const response = await ai.models.generateContent({
    model: "gemini-2.5-flash-preview-tts",
    contents: [{ parts: [{ text: `Speak in a professional, motivating coach voice for the MUSKYFIT team: ${text}` }] }],
    config: {
      responseModalities: [Modality.AUDIO],
      speechConfig: {
        voiceConfig: { prebuiltVoiceConfig: { voiceName: 'Puck' } },
      },
    },
  });

  return response.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data || null;
}

export async function analyzeWeeklyPerformance(name: string, gender: string, age: number, logs: DailyLog[], checkIn: WeeklyCheckIn): Promise<WeeklyReview> {
  const response = await ai.models.generateContent({
    model: "gemini-3-flash-preview",
    contents: `Analyze performance for ${name} (${gender}, ${age}y/o). Logs: ${logs.length} days. Check-in: Energy:${checkIn.energyLevel}, Stress:${checkIn.stressLevel}.`,
    config: {
      responseMimeType: "application/json",
      responseSchema: {
        type: Type.OBJECT,
        properties: {
          adherenceScore: { type: Type.NUMBER },
          coachMessage: { type: Type.STRING },
          directives: { type: Type.ARRAY, items: { type: Type.STRING } },
          status: { type: Type.STRING }
        },
        required: ["adherenceScore", "coachMessage", "directives", "status"]
      }
    }
  });

  const res = JSON.parse(response.text);
  return { id: 'rev_' + Date.now(), date: new Date().toISOString().split('T')[0], ...res };
}

export async function searchUniversalFood(query: string): Promise<FoodItem | null> {
  const response = await ai.models.generateContent({
    model: "gemini-3-flash-preview",
    contents: `Nutritional data for 100g of ${query}.`,
    config: {
      responseMimeType: "application/json",
      responseSchema: {
        type: Type.OBJECT,
        properties: {
          name: { type: Type.STRING },
          calories: { type: Type.NUMBER },
          protein: { type: Type.NUMBER },
          carbs: { type: Type.NUMBER },
          fats: { type: Type.NUMBER },
          servingSize: { type: Type.STRING }
        },
        required: ["name", "calories", "protein", "carbs", "fats"]
      }
    }
  });
  
  try {
    const res = JSON.parse(response.text);
    return { ...res, id: 'ai_' + Date.now(), type: 'WESTERN' };
  } catch { return null; }
}

export async function getMealAlternatives(meal: Meal): Promise<string[]> {
  const response = await ai.models.generateContent({
    model: "gemini-3-flash-preview",
    contents: `3 alternative meals for ${meal.name} with similar macros.`,
    config: {
      responseMimeType: "application/json",
      responseSchema: { type: Type.ARRAY, items: { type: Type.STRING } }
    }
  });
  try { return JSON.parse(response.text); } catch { return []; }
}
