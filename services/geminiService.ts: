
import { GoogleGenAI, Type } from "@google/genai";
import { IntakeData, Meal, DailyLog, WeeklyCheckIn, FoodItem } from "../types";

const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

const calculateAge = (dob: string): number => {
  const birthday = new Date(dob);
  const ageDifMs = Date.now() - birthday.getTime();
  const ageDate = new Date(ageDifMs);
  return Math.abs(ageDate.getUTCFullYear() - 1970);
};

export async function generatePersonalizedPlan(data: IntakeData): Promise<any> {
  const age = calculateAge(data.dob);
  const isLifestyleNiche = age >= 30;

  const response = await ai.models.generateContent({
    model: "gemini-3-pro-preview",
    contents: `Build a highly elite 12-week bespoke fitness protocol for ${data.name}. 
    Biometrics: ${age} years old, ${data.gender}, ${data.weight}kg, ${data.height}cm. 
    Profile: ${isLifestyleNiche ? '30+ Lifestyle Professional Focus (Priority: Joint health, longevity, and high-performance recovery)' : 'High Intensity / Performance Focus'}.
    Goal: ${data.goal}. 
    Cultural Nutrition Context: ${data.culturalPreference} (${data.dietPreference}).
    Exclusions: ${data.religiousExclusions}.
    Activity Level: ${data.activityLevel} with a ${data.jobType} career.
    
    Specific coaching directives:
    1. If age > 30, emphasize mobility and "Pre-hab" exercises.
    2. If goal is longevity, focus on lean muscle maintenance and cardiovascular health.
    3. Include culturally relevant high-protein food options for ${data.culturalPreference} context.
    4. Ensure training volume is sustainable for a ${data.jobType} lifestyle.`,
    config: {
      responseMimeType: "application/json",
      responseSchema: {
        type: Type.OBJECT,
        properties: {
          trainingDayMacros: { 
            type: Type.OBJECT, 
            properties: { 
              calories: { type: Type.NUMBER }, 
              p: { type: Type.NUMBER }, 
              c: { type: Type.NUMBER }, 
              f: { type: Type.NUMBER } 
            },
            required: ["calories", "p", "c", "f"]
          },
          restDayMacros: { 
            type: Type.OBJECT, 
            properties: { 
              calories: { type: Type.NUMBER }, 
              p: { type: Type.NUMBER }, 
              c: { type: Type.NUMBER }, 
              f: { type: Type.NUMBER } 
            },
            required: ["calories", "p", "c", "f"]
          },
          mealPlan: { 
            type: Type.ARRAY, 
            items: { 
              type: Type.OBJECT, 
              properties: { 
                mealType: { type: Type.STRING }, 
                name: { type: Type.STRING }, 
                ingredients: { type: Type.ARRAY, items: { type: Type.STRING } }, 
                instructions: { type: Type.STRING }, 
                macros: { 
                  type: Type.OBJECT,
                  properties: {
                    calories: { type: Type.NUMBER },
                    p: { type: Type.NUMBER },
                    c: { type: Type.NUMBER },
                    f: { type: Type.NUMBER }
                  },
                  required: ["calories", "p", "c", "f"]
                },
                substitutes: { type: Type.ARRAY, items: { type: Type.STRING } }
              },
              required: ["mealType", "name", "ingredients", "instructions", "macros"]
            } 
          },
          workoutSplit: { 
            type: Type.ARRAY, 
            items: { 
              type: Type.OBJECT, 
              properties: { 
                id: { type: Type.STRING }, 
                title: { type: Type.STRING }, 
                day: { type: Type.STRING },
                exercises: { 
                  type: Type.ARRAY, 
                  items: { 
                    type: Type.OBJECT,
                    properties: {
                      id: { type: Type.STRING },
                      name: { type: Type.STRING },
                      sets: { type: Type.NUMBER },
                      reps: { type: Type.STRING },
                      targetRpe: { type: Type.NUMBER },
                      tempo: { type: Type.STRING },
                      notes: { type: Type.STRING }
                    },
                    required: ["id", "name", "sets", "reps"]
                  } 
                } 
              },
              required: ["id", "title", "day", "exercises"]
            } 
          },
          coachAdvice: { type: Type.STRING }
        },
        required: ["trainingDayMacros", "restDayMacros", "mealPlan", "workoutSplit", "coachAdvice"]
      }
    }
  });
  
  const text = response.text;
  if (!text) throw new Error("AI Protocol Generation Failed");
  return JSON.parse(text);
}

export async function searchUniversalFood(query: string): Promise<FoodItem | null> {
  const response = await ai.models.generateContent({
    model: "gemini-3-flash-preview",
    contents: `Nutritional data for 100g of ${query}. Use global or regional context depending on food name.`,
    config: {
      responseMimeType: "application/json",
      responseSchema: {
        type: Type.OBJECT,
        properties: {
          name: { type: Type.STRING },
          calories: { type: Type.NUMBER },
          protein: { type: Type.NUMBER },
          carbs: { type: Type.NUMBER },
          fats: { type: Type.NUMBER },
          servingSize: { type: Type.STRING }
        },
        required: ["name", "calories", "protein", "carbs", "fats"]
      }
    }
  });
  
  const text = response.text;
  if (!text) return null;
  
  try {
    const res = JSON.parse(text);
    return { ...res, id: 'ai_' + Date.now(), type: 'WESTERN' };
  } catch { 
    return null; 
  }
}

export async function getMealAlternatives(meal: Meal): Promise<string[]> {
  const response = await ai.models.generateContent({
    model: "gemini-3-flash-preview",
    contents: `List 3 alternative high-protein meals for: ${meal.name}. Target Macros: ${meal.macros.calories}kcal, P:${meal.macros.p}g, C:${meal.macros.c}g, F:${meal.macros.f}g.`,
    config: {
      responseMimeType: "application/json",
      responseSchema: {
        type: Type.ARRAY,
        items: { type: Type.STRING }
      }
    }
  });
  
  const text = response.text;
  if (!text) return [];
  
  try {
    return JSON.parse(text);
  } catch { 
    return []; 
  }
}

export async function generatePerformanceReport(name: string, logs: DailyLog[], checkIn: WeeklyCheckIn): Promise<string> {
  const response = await ai.models.generateContent({
    model: "gemini-3-flash-preview",
    contents: `Synthesize performance data for ${name}.
    Steps: ${logs.map(l => l.steps).slice(0, 7).join(',')}.
    Compliance: ${logs.filter(l => l.workoutCompleted).length} training sessions this week.
    Stress/Sleep: ${checkIn.stressLevel}/10 stress, ${checkIn.sleepHours}h sleep.`,
    config: {
      systemInstruction: "You are the head coach at MUSKYFIT. Provide an elite performance summary. If the client is 30+, highlight recovery and consistent longevity wins."
    }
  });
  return response.text || "Report pending...";
}
